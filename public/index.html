<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>数据获取</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <style>
    html {
      font-family: "Helvetica Neue", Helvetica, PingFang, "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    }

    body {
      -webkit-overflow-scrolling: touch;
      position: relative;
    }

    h1,
    h2,
    h3,
    div,
    ul,
    li,
    dl,
    dt,
    dd,
    button,
    input,
    header,
    main,
    footer,
    p,
    button,
    body {
      padding: 0;
      margin: 0;
      -webkit-overflow-scrolling: touch;
      outline: none;
    }

    ul li {
      list-style: none;
    }

    header {
      text-align: center;
      height: 60px;
      line-height: 60px;
      font-size: 16px;
      font-weight: bold;
    }

    .main-wrap {
      display: flex;
      justify-content: space-around
    }

    .column-warp {
      flex-direction: column;
    }

    .main-wrap>div {
      align-items: center;
      display: flex;
      flex-direction: column;
      flex: 1;
      padding: 20px 0;
    }

    .title {
      font-size: 16px;
      color: #333;
      font-weight: bold;
      margin-bottom: 20px
    }

    .input-wrap {
      font-size: 14px;
      color: #333;
      margin: 5px;
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .input-wrap span {
      margin-right: 4px;
      width: 90px;
    }

    .input-wrap input {
      height: 28px;
      width: 160px;
      line-height: 28px;
      border-radius: 2px;
      border: 1px #cdcdcd solid;
      padding-left: 8px;
    }

    .left {
      border-right: 1px #ccc solid;
    }

    .download {
      width: 140px;
      font-size: 14px;
      height: 30px;
      font-weight: bold;
      border: 1px #cdcdcd solid;
      background: #fcfcfc;
      border-radius: 4px;
      margin-top: 20px;
      cursor: pointer;
    }

    .download:hover {
      opacity: .5;
    }

    #loading {
      width: 100%;
      height: 100vh;
      position: fixed;
      display: none;
      top: 0;
      left: 0;
      background: rgba(48, 47, 47, 0.7)
    }

    #loading svg {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto;
      width: 60px;
      height: 60px;
    }

    #date-select {
      height: 28px;
      width: 160px;
      line-height: 28px;
      border-radius: 2px;
      border: 1px #cdcdcd solid;
    }

    .table-warp {
      padding-top: 0 !important;
    }

    .table-warp .song-name {
      font-size: 18px;
      color: #333;
      font-weight: bold;
    }

    .table-warp .author {
      font-size: 14px;
      color: #999;
    }

    .table {
      width: 400px;
      display: flex;
      max-height: 200px;
      overflow-y: auto;
      border: #9f9f9f 1px solid;
      border-radius: 4px;
    }

    .table ul {
      flex: 1
    }

    .table ul li {
      padding: 4px;
      border-left: #9f9f9f 1px solid;
      border-bottom: #9f9f9f 1px solid;
      text-align: center;
      font-size: 14px;
      height: 16px;
      line-height: 16px;
    }

    .table ul li:last-child {
      border-bottom: none
    }

    .table-title {
      font-weight: bold;
    }

    .table .index-warp li {
      border-left: none;
    }

    .placeholder-block {
      height: 40px
    }

    #track-list {
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <header>数据表格下载</header>
  <div class="main-wrap">
    <div class="left">
      <div>
        <div class="title">曲库详情下载</div>
        <div class="input-wrap">
          <span>公司ID:</span>
          <input type="text" id="c-id" placeholder="请输入公司ID并点击下载按钮">
        </div>
      </div>
      <button id="dcb" class="download">查询并下载</button>
    </div>
    <div>
      <div>
        <div class="title">下载对应日期下的公司统计数据</div>
        <div class="input-wrap">
          <span>日期:</span>
          <select id="date-select">
            <option value="none">请选择日期</option>
            <option value="30">过去30天</option>
            <option value="90">过去90天</option>
            <option value="180">过去180天</option>
            <option value="365">过去365天</option>
          </select>
        </div>
      </div>
      <button class="download" id="ddb">查询并下载</button>
    </div>
  </div>
  <header>单曲查询</header>
  <div class="main-wrap column-warp">
    <div>
      <div>
        <div class="input-wrap">
          <span>歌曲名称:</span>
          <input type="text" id="song-name" placeholder="请输入歌曲名称">
        </div>
        <div class="input-wrap">
          <span>歌 手 名 :</span>
          <input type="text" id="artist-name" placeholder="请输入歌手名称">
        </div>
        <div class="input-wrap">
          <span>专辑名(选填):</span>
          <input type="text" id="album-name" placeholder="请输入专辑名称">
        </div>
        <div class="result"></div>
      </div>
      <button id="single-track" class="download">查询</button>
    </div>
    <div id="track-list-warp" class="table-warp" style="display:none">
      <div class="song-name" id="song-name-data" style="text-align:center"></div>
      <div class="author" id="artist-name-data" style="text-align:center"></div>
      <div class="table" id="track-list" style="width:600px;">
        <ul class="index-warp">
          <li class="table-title">
          </li>
          <li>评论/播放</li>
          <li>是否存在</li>
        </ul>
        <ul>
          <li class="table-title">itunes</l>
          <li>❌</li>
        </ul>
        <ul>
          <li class="table-title">kkbox</li>
          <li>❌</li>
        </ul>
        <ul>
          <li class="table-title">spotify</li>
          <li>❌</li>
        </ul>
        <ul>
          <li class="table-title">youtube</li>
        </ul>
        <ul>
          <li class="table-title">qq</li>
        </ul>
        <ul>
          <li class="table-title">网易云</li>
        </ul>
      </div>
    </div>
  </div>
  <header>按公司ID创建查询任务</header>
  <div class="main-wrap">
    <div>
      <div>
        <div class="input-wrap">
          <span>公司ID:</span>
          <input type="text" id="create-track-id" placeholder="请输入公司ID">
        </div>
      </div>
      <button id="create-track" class="download">创建查询任务</button>
    </div>
    <div class="common-list-warp">
      <div class="title" id="downloading-count">正在进行的查询总数：0</div>
      <div class="table" style="display:none" id="downloading-table">
        <ul class="index-warp">
          <li class="table-title">序号</l>
        </ul>
        <ul class="id-warp">
          <li class="table-title">公司ID</li>
        </ul>
        <ul class="status-warp">
          <li class="table-title">状态</li>
        </ul>
      </div>
    </div>
  </div>
  <header style="height:40px;line-height: 40px">已完成公司列表</header>
  <div class="tip" id="file-list-count"
    style="text-align: center;font-size: 14px;color:#999;height:28px;line-height:28px;padding-bottom:10px">总数：</div>
  <div style="padding-top:0;" class="main-wrap">
    <div class="common-list-warp " style="padding-top:0">
      <div class="table" id="file-list">
        <ul class="index-warp">
          <li class="table-title">序号</l>
        </ul>
        <ul class="id-warp">
          <li class="table-title">公司ID</li>
        </ul>
        <ul class="status-warp">
          <li class="table-title">状态</li>
        </ul>
        <ul class="other-warp">
          <li class="table-title">操作</li>
        </ul>
      </div>
    </div>
  </div>
  <div id="loading">
    <svg viewBox="0 0 38 38" xmlns="http://www.w3.org/2000/svg" stroke="#fff">
      <g fill="none" fill-rule="evenodd">
        <g transform="translate(1 1)" stroke-width="2">
          <circle stroke-opacity=".5" cx="18" cy="18" r="18" />
          <path d="M36 18c0-9.94-8.06-18-18-18">
            <animateTransform attributeName="transform" type="rotate" from="0 18 18" to="360 18 18" dur=".7s"
              repeatCount="indefinite" />
          </path>
        </g>
      </g>
    </svg>
  </div>
  <div class="placeholder-block"></div>
</body>
<script src="https://cdn.bootcss.com/moment.js/2.24.0/moment.min.js"></script>
<script src="https://cdn.bootcss.com/axios/0.19.0-beta.1/axios.js"></script>
<script>
  var host = ''
  function ctrlLoading(isShow) {
    if (isShow) document.getElementById('loading').style.display = 'block'
    else document.getElementById('loading').style.display = 'none'
  }
  function formatDownloadingTable() {
    document.getElementById('downloading-table').innerHTML = '<ul class="index-warp"><li class="table-title"> 序号</li></ul><ul class="id-warp"><li class="table-title">公司ID</li></ul><ul class="status-warp"><li class="table-title">状态</li></ul>'
  }
  function formatTrackList() {
    document.getElementById('track-list').innerHTML = '<ul class="index-warp"><li class="table-title"></li><li>评论/播放</li><li>是否存在</li></ul><ul><li class="table-title">itunes</li><li>❌</li></ul><ul><li class="table-title">kkbox</li><li>❌</li></ul><ul><li class="table-title">spotify</li><li>❌</li></ul><ul><li class="table-title">youtube</li></ul><ul><li class="table-title">qq</li></ul><ul><li class="table-title">网易云</li></ul>'
  }
  function getFileList() {
    window.axios.get(host + '/api/v1/list_files').then(res => {
      document.getElementById('file-list-count').innerHTML = '总数:' + res.data.data.length
      if (res.data.data.length) {
        var fileList = document.getElementById('file-list')
        res.data.data.forEach(function (value, i) {
          var index = document.createElement('li')
          var id = document.createElement('li')
          var downloadWarp = document.createElement('li')
          var download = document.createElement('a')
          index.innerHTML = i + 1
          id.innerHTML = value
          download.href = host + '/api/v1/download?filename=' + value
          download.innerHTML = '下载'
          downloadWarp.append(download)
          fileList.children[0].append(index)
          fileList.children[1].append(id)
          fileList.children[2].innerHTML += ('<li>已完成</li>')
          fileList.children[3].append(downloadWarp)
        })
      } else document.getElementById('file-list').style.display = 'none'
    }).catch(function (err) {
      console.log(err)
    })
  }
  function creatTrackList(data) {
    formatTrackList()
    var table = document.getElementById('track-list')
    document.getElementById('track-list-warp').style.display = 'block'
    table.children[1].innerHTML += (data.itunes && data.itunes.name ? '<li>✔️</li>' : '<li>❌</li>')
    table.children[2].innerHTML += (data.kkbox && data.kkbox.name ? '<li>✔️</li>' : '<li>❌</li>')
    table.children[3].innerHTML += (data.spotify && data.spotify.name ? '<li>✔️</li>' : '<li>❌</li>')
    table.children[4].innerHTML += (data.youtube && data.youtube.name ? '<li>' + data.youtube.views + '</li><li>✔️</li>' : '<li>❌</li><li>❌</li>')
    table.children[5].innerHTML += (data.qq && data.qq.name ? '<li>' + data.qq.comments + '</li><li>✔️</li>' : '<li>❌</li><li>❌</li>')
    table.children[6].innerHTML += (data.netease && data.netease.name ? '<li>' + data.netease.comments + '</li><li>✔️</li>' : '<li>❌</li><li>❌</li>')
  }
  function getDownloadList() {
    ctrlLoading(true)
    window.axios.get(host + '/api/v1/list_downloading').then(res => {
      if (res.data.data.length) {
        formatDownloadingTable()
        document.getElementById('downloading-count').innerHTML = '正在进行的查询总数:' + res.data.data.length
        document.getElementById('downloading-table').style.display = 'flex'
        res.data.data.forEach(function (value, i) {
          var downloadingTable = document.getElementById('downloading-table')
          var index = document.createElement('li')
          index.innerHTML = i + 1
          var id = document.createElement('li')
          id.innerHTML = value
          downloadingTable.children[0].append(index)
          downloadingTable.children[1].append(id)
          downloadingTable.children[2].innerHTML += '<li>正在查询下载中</li>'
        })
      } else document.getElementById('downloading-table').style.display = 'none'
      ctrlLoading(false)
    }).catch(function (err) {
      ctrlLoading(false)
      console.log(err)
    })
  }
  function createTask(id) {
    ctrlLoading(true)
    window.axios.get(host + '/api/v1/get_tracks?company_id=' + id).then(function (res) {
      ctrlLoading(false)
      getDownloadList()
      getFileList()
    }).catch((err) => {
      ctrlLoading(false)
      console.log(err)
    })
  }
  function getDateOptions() {
    ctrlLoading(true)
    window.axios.get(host + '/api/v1/company_statistics/dates').then(res => {
      ctrlLoading(false)
      res.data.dates.forEach(function (data) {
        var option = document.createElement('option')
        console.log(option)
        option.value = option.innerText = data
        document.getElementById('date-select').append(option)
      })
    }).catch(err => {
      ctrlLoading(false)
      if (err.msg) window.alert(err.msg)
      else window.alert('获取时间列表失败')
    })
  }
  getDateOptions()
  getFileList()
  getDownloadList()
  function downloadCsv(url) {
    var a = document.createElement('a')
    a.href = url
    a.click()
  }
  function downloadMD() {
    var ipt = document.getElementById('c-id')
    if (!ipt.value) return window.alert('请输入公司ID')
    ctrlLoading(true)
    downloadCsv('/api/v1/csv/music_index_detail/' + ipt.value)
    ipt.value = ''
    ctrlLoading(false)
  }
  function formatTimeHorizon(value) {
    var arr = [30, 90, 180, 365]
    if (arr.indexOf(Number(value)) > -1) {
      return [window.moment().startOf('day').subtract(value, 'day'), window.moment().endOf('day')]
    } else return [window.moment(value), window.moment(value).endOf('day')]
  }
  function downloadDL() {
    if (document.getElementById('date-select').value === 'none') return window.alert('请选择日期')
    var timeHorizon = formatTimeHorizon(document.getElementById('date-select').value)
    ctrlLoading(true)
    downloadCsv('/api/v1/csv/company_statistics?start_date=' + timeHorizon[0].unix() + '&end_date=' + timeHorizon[1].unix())
    ctrlLoading(false)
  }
  document.getElementById('dcb').onclick = downloadMD
  document.getElementById('ddb').onclick = downloadDL

  function getTrack(songName, artistName) {
    ctrlLoading(true)
    window.axios.get('/api/v1/get_track', { params: { song_name: songName, artist_name: artistName, album_name: albumName } }).then(function (res) {
      ctrlLoading(false)
      creatTrackList(res.data.data)
      document.getElementById('song-name-data').innerHTML = songName
      document.getElementById('artist-name-data').innerHTML = '作者：' + artistName
    }).catch(function (err) {
      console.log(err)
      ctrlLoading(false)
    })
  }
  document.getElementById('create-track').onclick = function () {
    if (document.getElementById('create-track-id').value) return createTask(document.getElementById('create-track-id').value)
    else window.alert('请输入公司ID')
  }

  document.getElementById('single-track').onclick = function () {
    getTrack(document.querySelector('#song-name').value, document.querySelector('#artist-name').value, document.querySelector('#album-name').value)
  }
</script>

</html>
